// uid-badge.js
(() => {
  const BADGE = "dcb-uid-badge";
  const IP_BADGE = "dcb-ip-badge";

  // --- IP 대역 정보 (통신사/VPN/Tor 등) ---
  const ISP_PATTERNS = {
    SKT: ["27.160","27.161","27.162","27.163","27.164","27.165","27.166","27.167","27.168","27.169","27.170","27.171","27.172","27.173","27.174","27.175","27.176","27.177","27.178","27.179","27.180","27.181","27.182","27.183","42.16","42.17","42.18","42.19","42.20","42.21","42.22","42.23","42.24","42.25","42.26","42.27","42.28","42.29","42.30","42.31","42.32","42.33","42.34","42.35","42.36","42.37","42.38","42.39","42.40","42.41","42.42","42.43","42.44","42.45","42.46","42.47","58.102","58.103","61.104","111.218","111.219","113.216","113.217","114.52","114.53","115.161","121.19","121.163","121.190","122.32","122.190","122.202","123.228","123.229","124.0","124.1","124.136","124.137","124.138","124.139","124.2","124.3","180.132","180.133","180.134","180.135","203.226","203.236","211.33","211.35","211.179","211.234","219.252","219.253","220.103","223.32","223.33","223.34","223.35","223.36","223.37","223.38","223.39","223.40","223.41","223.42","223.43","223.44","223.45","223.46","223.47","223.48","223.49","223.50","223.51","223.52","223.53","223.54","223.55","223.56","223.57","223.58","223.59","223.60","223.61","223.62","223.63"],
    KT: ["39.16","39.17","39.18","39.19","39.20","39.21","39.22","39.23","39.24","39.25","39.26","39.27","39.28","39.29","39.30","39.31","39.7","49.16","49.17","49.18","49.19","49.20","49.21","49.22","49.23","49.24","49.25","49.26","49.27","49.28","49.29","49.30","49.31","59.0","59.1","59.10","59.11","59.12","59.13","59.14","59.15","59.16","59.17","59.18","59.19","59.2","59.20","59.21","59.22","59.23","59.24","59.25","59.26","59.27","59.28","59.29","59.3","59.30","59.31","59.4","59.5","59.6","59.7","59.8","59.9","61.72","61.73","61.74","61.75","61.76","61.77","61.78","61.79","61.80","61.81","61.82","61.83","61.84","61.85","110.70","112.160","112.162","112.163","112.164","112.165","112.166","112.167","112.169","112.170","112.171","112.172","112.173","112.174","112.175","112.176","112.177","112.178","112.179","112.180","112.181","112.182","112.183","112.184","112.185","112.186","112.187","112.188","112.189","112.190","112.191","115.0","115.1","115.10","115.11","115.12","115.13","115.14","115.15","115.16","115.17","115.18","115.19","115.2","115.20","115.21","115.22","115.23","115.3","115.4","115.5","115.6","115.7","115.8","115.9","118.32","118.33","118.34","118.35","118.36","118.37","118.38","118.39","118.40","118.41","118.42","118.43","118.44","118.45","118.46","118.47","118.48","118.49","118.50","118.51","118.52","118.53","118.54","118.55","118.56","118.57","118.58","118.59","118.60","118.61","118.62","118.63","118.235","119.71","119.192","119.193","119.194","119.195","119.196","119.197","119.198","119.199","119.200","119.201","119.202","119.203","119.204","119.205","119.206","119.207","119.208","119.209","119.210","119.211","119.212","119.213","119.214","119.215","119.216","119.217","119.218","119.219","119.220","119.221","119.222","119.223","121.128","121.129","121.130","121.131","121.132","121.133","121.134","121.135","121.136","121.137","121.138","121.139","121.140","121.141","121.142","121.143","121.145","121.146","121.147","121.148","121.149","121.150","121.151","121.152","121.153","121.154","121.155","121.156","121.157","121.158","121.159","121.160","121.161","121.162","121.164","121.165","121.166","121.167","121.168","121.169","121.170","121.171","121.172","121.173","121.174","121.175","125.128","125.129","125.130","125.131","125.132","125.133","125.134","125.135","125.136","125.137","125.138","125.139","125.140","125.141","125.142","125.143","125.144","125.145","125.146","125.147","125.148","125.149","125.150","125.151","125.152","125.153","125.154","125.155","125.156","125.157","125.158","125.159","147.6","168.126","168.248","168.249","175.202","175.223","175.252","175.253","183.100","183.101","183.102","183.103","183.104","183.105","183.106","183.107","183.108","183.109","183.110","183.111","183.112","183.113","183.114","183.115","183.116","183.117","183.118","183.119","183.120","183.121","183.122","183.123","183.124","183.125","183.126","183.127","183.96","183.97","183.98","183.99","203.236","210.90","210.125","210.183","210.204","210.222","210.223","211.46","211.246","220.70","220.71","220.72","220.73","220.74","220.75","220.76","220.77","220.78","220.79","220.80","220.81","220.82","220.83","220.84","220.85","220.86","220.87","220.88","220.89","220.90","220.91","220.92","220.93","220.94","220.95","221.144","221.145","221.146","221.147","221.148","221.149","221.150","221.151","221.152","221.153","221.154","221.155","221.156","221.157","221.158","221.159","221.160","221.161","221.162","221.163","221.164","221.165","221.166","221.167","221.168"],
    LGU: ["1.208","1.209","1.210","1.211","1.212","1.213","1.214","1.215","1.216","1.217","1.218","1.219","1.220","1.221","1.222","1.223","14.4","14.41","49.160","49.161","49.162","49.163","49.164","49.165","49.166","49.167","49.168","49.169","49.170","49.171","49.175","58.29","58.72","58.73","58.74","58.75","58.76","58.77","58.78","58.79","59.186","59.187","61.32","61.33","61.34","61.35","61.36","61.37","61.38","61.39","61.40","61.41","61.42","61.43","61.108","106.101","106.102","106.240","106.241","106.242","106.243","106.244","106.245","106.246","106.247","106.248","106.249","106.250","106.251","106.252","106.253","106.254","106.255","112.144","112.145","112.146","112.147","112.148","112.149","112.150","112.151","112.152","112.153","112.154","112.155","112.156","112.157","112.158","112.159","112.216","112.217","112.218","112.219","112.220","112.221","112.222","112.223","114.2","114.200","115.88","115.89","115.90","115.91","115.92","115.93","115.94","115.95","115.136","115.137","115.138","115.139","115.140","115.141","115.142","115.143","116.32","116.33","116.34","116.35","116.36","116.37","116.38","116.39","116.40","116.41","116.42","116.43","116.44","116.45","116.46","116.47","117.52","117.110","117.111","118.128","118.129","118.130","118.131","119.64","119.65","119.66","119.67","119.68","119.69","119.70","122.33","122.34","122.35","122.36","122.37","122.38","122.39","122.40","122.41","122.42","122.43","122.44","122.45","122.46","122.47","123.140","123.141","123.142","123.143","125.176","125.177","125.178","125.179","125.180","125.181","125.182","125.183","125.184","125.185","125.186","125.187","125.188","125.189","125.190","125.191","164.124","210.182","210.206","210.207","210.216","211.36","211.60","211.200","211.201","211.202","211.203","211.204","211.205","211.206","211.207","211.208","211.209","211.226"],
    SKB: ["1.224","1.225","1.226","1.227","1.228","1.229","1.230","1.231","1.232","1.234","1.235","1.236","1.237","1.238","1.239","1.240","1.241","1.242","1.243","1.244","1.245","1.246","1.247","1.248","1.249","1.250","1.251","1.252","1.253","1.254","1.255","39.112","39.113","39.114","39.115","39.116","39.117","39.118","39.119","39.120","39.121","39.122","39.123","39.124","39.125","39.126","39.127","58.120","58.121","58.122","58.123","58.124","58.125","58.126","58.127","58.224","58.225","58.226","58.227","58.228","58.229","58.230","58.231","58.232","58.233","58.234","58.235","58.236","58.237","58.238","58.239","61.98","61.99","61.105","61.253","110.8","110.9","110.10","110.11","110.12","110.13","110.14","110.15","114.201","114.202","114.203","114.204","114.205","114.206","114.207","116.120","116.121","116.122","116.123","116.124","116.125","116.126","116.127","118.216","118.217","118.218","118.219","118.220","118.221","118.222","118.223","123.111","123.212","123.213","123.214","123.215","124.111","221.138","221.139","221.140","221.141","221.142","221.143","222.232","222.233","222.234","222.235","222.236","222.237","222.238","222.239"],
    삼성: ["180.236","180.237","180.238"],
    Tor: ["1.161","18.18","18.27","18.85","23.106","23.239","27.255","31.31","31.185","37.48","45.64","45.66","45.76","45.114","45.128","45.129","45.137","45.141","46.29","46.166","46.182","46.232","51.38","51.75","51.79","51.81","51.83","51.89","51.158","51.195","51.210","51.254","54.36","54.37","62.171","62.178","64.124","65.181","66.70","66.146","66.230","77.81","77.247","80.67","80.79","80.127","80.241","81.16","82.118","82.221","82.223","83.96","83.97","84.19","85.93","87.120","89.34","89.163","89.223","91.92","91.240","91.244","91.250","94.16","94.102","94.142","94.230","95.142","95.154","95.211","95.143","97.74","103.75","103.125","103.16","103.194","103.208","103.236","104.194","104.196","104.2","104.218","104.244","104.4","107.189","109.169","109.194","109.201","109.248","109.69","109.70","109.7","111.9","114.158","114.32","115.73","118.163","119.237","122.147","123.3","124.109","126.75","128.14","128.31","130.149","130.204","137.74","139.162","139.28","139.99","142.44","142.58","142.93","143.202","144.172","145.239","146.59","149.56","149.202","151.53","151.73","151.77","153.229","154.127","156.54","157.157","157.161","157.23","158.174","159.89","160.119","160.282","162.244","162.247","164.132","164.77","166.7","167.114","167.99","169.197","171.22","171.244","172.96","172.98","173.14","173.199","173.244","176.1","176.10","176.126","176.152","176.214","176.31","176.53","177.205","178.2","178.9","178.20","178.165","178.175","178.239","178.254","178.32","179.48","180.15","180.149","184.75","185.1","185.4","185.65","185.100","185.103","185.107","185.112","185.113","185.129","185.130","185.165","185.175","185.191","185.195","185.205","185.248","188.213","193.32","193.118","193.180","193.218","195.154","195.206","195.254","198.96","198.251","200.38","200.56","200.98","201.80","204.27","205.185","209.141","212.21","212.47","213.95","216.18","216.186","216.218","216.239","217.12","217.79","217.182"],
    VPN: ["5.2","5.9","5.79","5.152","5.181","5.189","5.252","5.254","13.124","14.136","23.227","23.249","23.29","31.3","31.7","31.193","31.220","37.58","37.139","37.221","37.228","37.235","41.215","41.223","46.4","46.17","46.19","46.28","46.38","46.101","46.165","46.183","46.246","50.7","50.116","54.225","54.243","62.210","64.34","66.85","69.25","74.201","74.82","77.237","78.137","81.4","81.17","82.145","85.234","88.150","89.46","91.186","91.221","92.48","92.222","94.76","94.242","95.141","95.215","96.126","103.10","103.18","103.27","103.4","103.6","103.254","104.131","104.236","106.185","106.186","106.187","107.155","107.161","107.170","107.181","107.190","107.191","107.22","108.61","109.74","109.200","128.199","141.0","146.255","149.154","149.62","151.236","158.255","162.159","162.213","162.217","162.218","162.221","162.243","167.88","168.235","172.107","173.255","176.58","176.9","176.123","177.67","178.62","178.79","178.162","178.209","178.255","179.43","182.50","185.9","185.12","185.26","185.29","185.34","185.35","185.82","185.87","185.104","185.107","185.112","185.113","185.135","185.182","185.189","185.191","185.222","185.248","188.226","192.30","192.34","192.40","192.71","192.73","192.81","192.99","192.110","192.121","192.184","192.211","192.241","193.36","193.182","195.176","195.181","195.189","196.240","198.16","198.58","198.147","198.211","199.115","199.241","207.244","208.68","209.58","209.222","211.197","212.102","213.104","213.229","217.25","217.78","217.170"],
    Proxy: ["37.120","51.254","66.11","66.249","84.17","92.38","107.167","112.168","178.128","178.33","185.129","185.4","185.248","195.206","198.16"],
    해외: ["5.189","8.38","18.248","23.94","31.41","46.45","46.167","46.188","46.235","50.247","59.127","59.179","60.248","62.133","64.124","65.19","67.205","69.30","74.207","79.134","79.143","80.169","84.45","88.77","88.99","89.38","89.68","89.187","89.221","89.234","91.121","91.138","93.64","93.174","95.72","95.216","98.194","99.199","101.99","103.56","104.200","104.238","125.212","128.52","128.153","134.209","138.197","144.217","146.57","150.107","155.4","158.69","158.193","163.172","165.231","167.86","171.25","173.212","176.213","178.17","178.33","185.10","185.35","185.87","185.104","185.135","185.189","185.220","185.222","185.29","188.65","193.34","193.90","193.107","193.169","194.169","195.40","195.176","195.228","199.24","199.25","199.249","199.254","199.68","199.87","199.195","201.17","202.150","202.165","204.11","204.85","206.189","206.248","208.113","209.95","210.3","211.125","212.83","213.32","213.108","217.25","198.98"],
    애플: ["104.28","140.248","172.224","172.225","172.226"],
    서울대: ["147.46","147.47"],
    고려대: ["163.152"],
    연세대: ["1.233","165.132"],
    이화여자대: ["163.180","203.255"],
    서강대: ["163.239"],
    부산대: ["61.42","164.125"],
    한양대: ["166.104","218.235"],
    중앙대: ["165.194","219.255"],
    경북대: ["155.230"],
    동아대: ["168.115"],
    영남대: ["165.229"],
    인하대: ["165.246"],
    전남대: ["1.227","168.131"],
    충남대: ["58.76","168.188"],
    포항공과대: ["141.223","141.224"],
    성균관대: ["115.145","203.252"],
    한국과학기술원: ["143.218","143.248"],
    건국대: ["202.30","210.106"],
    아주대: ["202.30","221.162"],
    한국외국어대: ["203.232"],
    서울시립대: ["203.249","222.109"],
    동국대: ["203.247"],
    홍익대: ["203.249"],
    전북대: ["61.99","192.203"],
    충북대: ["203.253","210.115"],
    강원대: ["192.203"],
    제주대: ["192.203"],
    원광대: ["203.249"],
    GIST: ["203.230"],
    DGIST: ["210.123"],
    UNIST: ["58.126"]
  };

  // IP에서 통신사/VPN/프록시 정보 추출
  function detectISP(ip) {
    if (!ip) return null;
    const prefix = ip.split(".").slice(0, 3).join(".");
    for (const [type, prefixes] of Object.entries(ISP_PATTERNS)) {
      if (prefixes.includes(prefix)) {
        return type;
      }
    }
    return null;
  }

  // --- state & helpers for ON/OFF ---
  let showEnabled = true;

  function removeAllBadges() {
    document.querySelectorAll("." + BADGE + ", ." + IP_BADGE).forEach((el) => el.remove());
  }

  // 간단한 스타일
  function ensureStyle() {
    if (document.getElementById(BADGE)) return;
    const st = document.createElement("style");
    st.id = BADGE;
    st.textContent = `
      .${BADGE}{
        margin-left:6px; font-size:11px; color:#fff;
        background:linear-gradient(135deg, rgba(16,185,129,.9), rgba(5,150,105,.9));
        padding:2px 7px; border-radius:11px;
        vertical-align:middle;
        font-weight:600;
        box-shadow:0 1px 3px rgba(0,0,0,.12);
        letter-spacing:0.3px;
      }
      .${IP_BADGE}{
        margin-left:6px; font-size:11px; color:#fff;
        padding:2px 7px; border-radius:11px;
        vertical-align:middle;
        font-weight:600;
        box-shadow:0 1px 3px rgba(0,0,0,.12);
        letter-spacing:0.3px;
      }
      .${IP_BADGE}.skt{ background:linear-gradient(135deg, rgba(237,28,36,.92), rgba(200,20,30,.92)); }
      .${IP_BADGE}.kt{ background:linear-gradient(135deg, rgba(255,102,0,.92), rgba(230,85,0,.92)); }
      .${IP_BADGE}.lgu{ background:linear-gradient(135deg, rgba(204,0,51,.92), rgba(170,0,40,.92)); }
      .${IP_BADGE}.skb{ background:linear-gradient(135deg, rgba(248,113,113,.92), rgba(239,68,68,.92)); }
      .${IP_BADGE}.삼성{ background:linear-gradient(135deg, rgba(59,130,246,.92), rgba(29,78,216,.92)); }
      .${IP_BADGE}.tor{ background:linear-gradient(135deg, rgba(109,40,217,.92), rgba(89,35,156,.92)); }
      .${IP_BADGE}.vpn{ background:linear-gradient(135deg, rgba(59,130,246,.92), rgba(37,99,235,.92)); }
      .${IP_BADGE}.proxy{ background:linear-gradient(135deg, rgba(251,146,60,.92), rgba(249,115,22,.92)); }
      .${IP_BADGE}.해외{ background:linear-gradient(135deg, rgba(107,114,128,.92), rgba(75,85,99,.92)); }
      .${IP_BADGE}.애플{ background:linear-gradient(135deg, rgba(34,197,94,.92), rgba(22,163,74,.92)); }
      .${IP_BADGE}.서울대{ background:linear-gradient(135deg, rgba(59,130,246,.92), rgba(37,99,235,.92)); }
      .${IP_BADGE}.고려대{ background:linear-gradient(135deg, rgba(139,92,246,.92), rgba(124,58,255,.92)); }
      .${IP_BADGE}.연세대{ background:linear-gradient(135deg, rgba(236,72,153,.92), rgba(219,39,119,.92)); }
      .${IP_BADGE}.이화여자대{ background:linear-gradient(135deg, rgba(168,85,247,.92), rgba(147,51,234,.92)); }
      .${IP_BADGE}.서강대{ background:linear-gradient(135deg, rgba(34,211,238,.92), rgba(6,182,212,.92)); }
      .${IP_BADGE}.부산대{ background:linear-gradient(135deg, rgba(34,197,94,.92), rgba(5,150,105,.92)); }
      .${IP_BADGE}.한양대{ background:linear-gradient(135deg, rgba(249,115,22,.92), rgba(234,88,12,.92)); }
      .${IP_BADGE}.중앙대{ background:linear-gradient(135deg, rgba(251,191,36,.92), rgba(217,119,6,.92)); }
      .${IP_BADGE}.경북대{ background:linear-gradient(135deg, rgba(244,63,94,.92), rgba(220,38,38,.92)); }
      .${IP_BADGE}.동아대{ background:linear-gradient(135deg, rgba(6,182,212,.92), rgba(14,165,233,.92)); }
      .${IP_BADGE}.영남대{ background:linear-gradient(135deg, rgba(124,58,255,.92), rgba(99,102,241,.92)); }
      .${IP_BADGE}.인하대{ background:linear-gradient(135deg, rgba(236,72,153,.92), rgba(236,32,91,.92)); }
      .${IP_BADGE}.전남대{ background:linear-gradient(135deg, rgba(34,197,94,.92), rgba(16,185,129,.92)); }
      .${IP_BADGE}.충남대{ background:linear-gradient(135deg, rgba(249,115,22,.92), rgba(245,158,11,.92)); }
      .${IP_BADGE}.포항공과대{ background:linear-gradient(135deg, rgba(59,130,246,.92), rgba(59,130,246,.92)); }
      .${IP_BADGE}.성균관대{ background:linear-gradient(135deg, rgba(139,92,246,.92), rgba(147,51,234,.92)); }
      .${IP_BADGE}.한국과학기술원{ background:linear-gradient(135deg, rgba(34,211,238,.92), rgba(6,182,212,.92)); }
      .${IP_BADGE}.건국대{ background:linear-gradient(135deg, rgba(34,197,94,.92), rgba(22,163,74,.92)); }
      .${IP_BADGE}.아주대{ background:linear-gradient(135deg, rgba(249,115,22,.92), rgba(234,88,12,.92)); }
      .${IP_BADGE}.한국외국어대{ background:linear-gradient(135deg, rgba(251,191,36,.92), rgba(217,119,6,.92)); }
      .${IP_BADGE}.서울시립대{ background:linear-gradient(135deg, rgba(244,63,94,.92), rgba(220,38,38,.92)); }
      .${IP_BADGE}.동국대{ background:linear-gradient(135deg, rgba(6,182,212,.92), rgba(14,165,233,.92)); }
      .${IP_BADGE}.홍익대{ background:linear-gradient(135deg, rgba(124,58,255,.92), rgba(99,102,241,.92)); }
      .${IP_BADGE}.전북대{ background:linear-gradient(135deg, rgba(236,72,153,.92), rgba(236,32,91,.92)); }
      .${IP_BADGE}.충북대{ background:linear-gradient(135deg, rgba(34,197,94,.92), rgba(16,185,129,.92)); }
      .${IP_BADGE}.강원대{ background:linear-gradient(135deg, rgba(249,115,22,.92), rgba(245,158,11,.92)); }
      .${IP_BADGE}.제주대{ background:linear-gradient(135deg, rgba(59,130,246,.92), rgba(37,99,235,.92)); }
      .${IP_BADGE}.원광대{ background:linear-gradient(135deg, rgba(139,92,246,.92), rgba(124,58,255,.92)); }
      .${IP_BADGE}.GIST{ background:linear-gradient(135deg, rgba(236,72,153,.92), rgba(219,39,119,.92)); }
      .${IP_BADGE}.DGIST{ background:linear-gradient(135deg, rgba(168,85,247,.92), rgba(147,51,234,.92)); }
      .${IP_BADGE}.UNIST{ background:linear-gradient(135deg, rgba(34,211,238,.92), rgba(6,182,212,.92)); }
    `;
    (document.head || document.documentElement).appendChild(st);
  }

  const isIpLike = (s) =>
    /^\d{1,3}(?:\.\d{1,3}){1,3}$/.test(String(s || "").trim());

  // writer 블록에서 회원 UID 추출
  function extractUid(writer) {
    // 1) data-uid
    let uid = writer.getAttribute("data-uid") || "";
    if (uid && !isIpLike(uid)) return uid;

    // 2) 새로고침 데이터 블록(title/text에 (uid))
    let rf =
      writer.querySelector(".refresherUserData") ||
      writer.parentElement?.querySelector(".refresherUserData");
    if (rf) {
      uid = rf.getAttribute("title") || "";
      if (!uid) {
        const m = (rf.textContent || "").match(/\(([A-Za-z0-9._-]+)\)/);
        if (m) uid = m[1];
      }
      if (uid && !isIpLike(uid)) return uid;
    }

    // 3) 갤로그 링크에서 추출(onclick/href)
    const link =
      writer.parentElement?.querySelector(
        '.writer_nikcon,[onclick*="gallog.dcinside.com"],a[href*="gallog.dcinside.com"]'
      ) || writer.querySelector('a[href*="gallog.dcinside.com"]');

    if (link) {
      const src =
        link.getAttribute("onclick") || link.getAttribute("href") || "";
      // 예: https://gallog.dcinside.com/SomeUID
      let m = src.match(/gallog\.dcinside\.com\/([A-Za-z0-9._-]+)/);
      if (m && m[1] && !isIpLike(m[1])) return m[1];
      // 혹시 다른 형태가 있으면 괄호 안 UID 시도
      m = src.match(/\(([A-Za-z0-9._-]+)\)/);
      if (m && m[1] && !isIpLike(m[1])) return m[1];
    }

    return "";
  }

  // IP 주소 추출
  function extractIP(writer) {
    // 1) data-ip 속성 먼저 확인 (가장 정확)
    const ip = writer.getAttribute("data-ip");
    if (ip) return ip;
    
    // 2) IP는 괄호 안에 표시됨: (211.235.xxx.xxx)
    const ipText = writer.textContent || "";
    const match = ipText.match(/\((\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})\)/);
    return match ? match[1] : null;
  }

  function placeBadge(writer) {
    if (!showEnabled) return; // OFF면 표시 안 함

    const nick = writer.querySelector(".nickname");
    if (!nick) return;

    // 이미 있으면 중복 생성 방지
    if (writer.querySelector(`.${BADGE}, .${IP_BADGE}`)) return;

    // 회원 UID 체크
    const uid = extractUid(writer);
    if (uid) {
      // 회원 뱃지
      const span = document.createElement("span");
      span.className = BADGE;
      span.textContent = `(${uid})`;
      span.title = "등록 회원";
      nick.insertAdjacentElement("afterend", span);
    } else {
      // 비회원 IP 체크
      const ip = extractIP(writer);
      if (ip) {
        const type = detectISP(ip);
        if (type) {
          const span = document.createElement("span");
          span.className = IP_BADGE;
          
          // 타입별 클래스 추가
          const classMap = {
            SKT: "skt",
            KT: "kt",
            LGU: "lgu",
            SKB: "skb",
            삼성: "삼성",
            Tor: "tor",
            VPN: "vpn",
            Proxy: "proxy",
            해외: "해외",
            애플: "애플",
            서울대: "서울대",
            고려대: "고려대",
            연세대: "연세대",
            이화여자대: "이화여자대",
            서강대: "서강대",
            부산대: "부산대",
            한양대: "한양대",
            중앙대: "중앙대",
            경북대: "경북대",
            동아대: "동아대",
            영남대: "영남대",
            인하대: "인하대",
            전남대: "전남대",
            충남대: "충남대",
            포항공과대: "포항공과대",
            성균관대: "성균관대",
            한국과학기술원: "한국과학기술원",
            건국대: "건국대",
            아주대: "아주대",
            한국외국어대: "한국외국어대",
            서울시립대: "서울시립대",
            동국대: "동국대",
            홍익대: "홍익대",
            전북대: "전북대",
            충북대: "충북대",
            강원대: "강원대",
            제주대: "제주대",
            원광대: "원광대",
            GIST: "GIST",
            DGIST: "DGIST",
            UNIST: "UNIST"
          };
          const className = classMap[type];
          if (className) span.classList.add(className);
          
          span.textContent = type;
          span.title = `${type} (${ip})`;
          nick.insertAdjacentElement("afterend", span);
        }
      }
    }
  }

  function scan() {
    if (!showEnabled) {
      removeAllBadges();
      return;
    }
    ensureStyle();
    // 모든 작성자 블록
    document.querySelectorAll(".gall_writer").forEach(placeBadge);
  }

  // --- storage: 초기 로드 & 변경 반영 ---
  try {
    if (chrome && chrome.storage && chrome.storage.sync) {
      chrome.storage.sync.get(
        { showUidBadge: true },
        ({ showUidBadge }) => {
          showEnabled = !!showUidBadge;
          if (!showEnabled) removeAllBadges();
          else scan();
        }
      );

      chrome.storage.onChanged.addListener((changes, area) => {
        if (area !== "sync" || !changes.showUidBadge) return;
        showEnabled = !!changes.showUidBadge.newValue;
        if (!showEnabled) removeAllBadges();
        else scan();
      });
    }
  } catch (e) {
    // storage가 없으면 기본값(true)로 동작
  }

  // 초기 + 동적 로딩 대응(리스트 리프레셔/댓글 새로고침 등)
  let scheduled = false;
  const mo = new MutationObserver(() => {
    if (scheduled) return;
    scheduled = true;
    requestAnimationFrame(() => {
      scheduled = false;
      scan();
    });
  });

  if (document.readyState === "loading") {
    document.addEventListener(
      "DOMContentLoaded",
      () => {
        scan();
        mo.observe(document.body, { childList: true, subtree: true });
      },
      { once: true }
    );
  } else {
    scan();
    mo.observe(document.body, { childList: true, subtree: true });
  }
})();
